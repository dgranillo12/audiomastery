import React, { useState, useRef, useEffect } from 'react';
import { Upload, Play, Pause, Download, Settings, Volume2, Sliders } from 'lucide-react';

const AudioMasteringTool = () => {
  const [audioFile, setAudioFile] = useState(null);
  const [referenceFile, setReferenceFile] = useState(null);
  const [isPlaying, setIsPlaying] = useState(false);
  const [currentTime, setCurrentTime] = useState(0);
  const [duration, setDuration] = useState(0);
  const [masteringSettings, setMasteringSettings] = useState({
    style: 'balanced',
    targetLUFS: -14,
    compression: 50,
    eq: 50,
    stereoWidth: 50,
    saturation: 30
  });
  
  const audioRef = useRef(null);
  const audioContextRef = useRef(null);
  const sourceNodeRef = useRef(null);
  const gainNodeRef = useRef(null);

  const stylePresets = {
    balanced: { compression: 50, eq: 50, stereoWidth: 50, saturation: 30, targetLUFS: -14 },
    pop: { compression: 70, eq: 60, stereoWidth: 60, saturation: 40, targetLUFS: -9 },
    rock: { compression: 60, eq: 65, stereoWidth: 55, saturation: 50, targetLUFS: -11 },
    hiphop: { compression: 75, eq: 70, stereoWidth: 40, saturation: 45, targetLUFS: -10 },
    classical: { compression: 30, eq: 40, stereoWidth: 70, saturation: 15, targetLUFS: -18 },
    podcast: { compression: 80, eq: 55, stereoWidth: 30, saturation: 20, targetLUFS: -16 }
  };

  const lufsStandards = [
    { name: 'Spotify', value: -14, desc: 'Streaming standard' },
    { name: 'YouTube', value: -13, desc: 'Video platform' },
    { name: 'Apple Music', value: -16, desc: 'Premium quality' },
    { name: 'Radio', value: -9, desc: 'Broadcast loud' },
    { name: 'Film/TV', value: -23, desc: 'Cinema standard' }
  ];

  const handleFileUpload = (e, type) => {
    const file = e.target.files[0];
    if (file && file.type.startsWith('audio/')) {
      const url = URL.createObjectURL(file);
      if (type === 'main') {
        setAudioFile({ file, url, name: file.name });
      } else {
        setReferenceFile({ file, url, name: file.name });
      }
    }
  };

  const handleStyleChange = (style) => {
    setMasteringSettings({ ...masteringSettings, ...stylePresets[style], style });
  };

  const togglePlayPause = () => {
    if (!audioRef.current) return;
    
    if (isPlaying) {
      audioRef.current.pause();
    } else {
      audioRef.current.play();
    }
    setIsPlaying(!isPlaying);
  };

  const handleTimeUpdate = () => {
    if (audioRef.current) {
      setCurrentTime(audioRef.current.currentTime);
    }
  };

  const handleLoadedMetadata = () => {
    if (audioRef.current) {
      setDuration(audioRef.current.duration);
    }
  };

  const handleSeek = (e) => {
    const rect = e.currentTarget.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const percentage = x / rect.width;
    const newTime = percentage * duration;
    if (audioRef.current) {
      audioRef.current.currentTime = newTime;
      setCurrentTime(newTime);
    }
  };

  const formatTime = (time) => {
    const minutes = Math.floor(time / 60);
    const seconds = Math.floor(time % 60);
    return `${minutes}:${seconds.toString().padStart(2, '0')}`;
  };

  const handleExport = () => {
    alert('Export functionality would process the audio with the selected settings and download a mastered WAV/MP3 file. In a full implementation, this would use Web Audio API processing or server-side audio processing.');
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 text-white p-6">
      <div className="max-w-6xl mx-auto">
        <h1 className="text-4xl font-bold mb-2 text-center bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
          Audio Mastering Studio
        </h1>
        <p className="text-center text-gray-400 mb-8">Professional mastering at your fingertips</p>

        <div className="grid md:grid-cols-2 gap-6 mb-6">
          {/* Main Audio Upload */}
          <div className="bg-gray-800 rounded-lg p-6 border border-purple-500/30">
            <h2 className="text-xl font-semibold mb-4 flex items-center gap-2">
              <Upload className="w-5 h-5" />
              Your Audio Track
            </h2>
            <label className="block">
              <input
                type="file"
                accept="audio/*"
                onChange={(e) => handleFileUpload(e, 'main')}
                className="hidden"
              />
              <div className="border-2 border-dashed border-purple-500 rounded-lg p-8 text-center cursor-pointer hover:border-purple-400 transition-colors">
                {audioFile ? (
                  <div>
                    <div className="text-green-400 mb-2">✓ Loaded</div>
                    <div className="text-sm text-gray-300">{audioFile.name}</div>
                  </div>
                ) : (
                  <div>
                    <Upload className="w-12 h-12 mx-auto mb-2 text-purple-400" />
                    <p className="text-gray-300">Click to upload audio</p>
                    <p className="text-sm text-gray-500 mt-1">MP3, WAV, FLAC, etc.</p>
                  </div>
                )}
              </div>
            </label>
          </div>

          {/* Reference Track Upload */}
          <div className="bg-gray-800 rounded-lg p-6 border border-pink-500/30">
            <h2 className="text-xl font-semibold mb-4 flex items-center gap-2">
              <Settings className="w-5 h-5" />
              Reference Track (Optional)
            </h2>
            <label className="block">
              <input
                type="file"
                accept="audio/*"
                onChange={(e) => handleFileUpload(e, 'reference')}
                className="hidden"
              />
              <div className="border-2 border-dashed border-pink-500 rounded-lg p-8 text-center cursor-pointer hover:border-pink-400 transition-colors">
                {referenceFile ? (
                  <div>
                    <div className="text-green-400 mb-2">✓ Loaded</div>
                    <div className="text-sm text-gray-300">{referenceFile.name}</div>
                  </div>
                ) : (
                  <div>
                    <Upload className="w-12 h-12 mx-auto mb-2 text-pink-400" />
                    <p className="text-gray-300">Upload reference master</p>
                    <p className="text-sm text-gray-500 mt-1">Match professional sound</p>
                  </div>
                )}
              </div>
            </label>
          </div>
        </div>

        {/* Audio Player */}
        {audioFile && (
          <div className="bg-gray-800 rounded-lg p-6 mb-6 border border-purple-500/30">
            <audio
              ref={audioRef}
              src={audioFile.url}
              onTimeUpdate={handleTimeUpdate}
              onLoadedMetadata={handleLoadedMetadata}
              onEnded={() => setIsPlaying(false)}
            />
            
            <div className="flex items-center gap-4 mb-4">
              <button
                onClick={togglePlayPause}
                className="bg-purple-600 hover:bg-purple-700 rounded-full p-3 transition-colors"
              >
                {isPlaying ? <Pause className="w-6 h-6" /> : <Play className="w-6 h-6 ml-1" />}
              </button>
              
              <div className="flex-1">
                <div
                  className="bg-gray-700 rounded-full h-2 cursor-pointer relative overflow-hidden"
                  onClick={handleSeek}
                >
                  <div
                    className="bg-gradient-to-r from-purple-500 to-pink-500 h-full rounded-full transition-all"
                    style={{ width: `${(currentTime / duration) * 100}%` }}
                  />
                </div>
                <div className="flex justify-between text-sm text-gray-400 mt-1">
                  <span>{formatTime(currentTime)}</span>
                  <span>{formatTime(duration)}</span>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Style Presets */}
        <div className="bg-gray-800 rounded-lg p-6 mb-6 border border-purple-500/30">
          <h2 className="text-xl font-semibold mb-4 flex items-center gap-2">
            <Sliders className="w-5 h-5" />
            Mastering Style
          </h2>
          <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
            {Object.keys(stylePresets).map(style => (
              <button
                key={style}
                onClick={() => handleStyleChange(style)}
                className={`p-3 rounded-lg capitalize transition-all ${
                  masteringSettings.style === style
                    ? 'bg-gradient-to-r from-purple-600 to-pink-600 shadow-lg scale-105'
                    : 'bg-gray-700 hover:bg-gray-600'
                }`}
              >
                {style}
              </button>
            ))}
          </div>
        </div>

        {/* Loudness Standards */}
        <div className="bg-gray-800 rounded-lg p-6 mb-6 border border-pink-500/30">
          <h2 className="text-xl font-semibold mb-4 flex items-center gap-2">
            <Volume2 className="w-5 h-5" />
            Target Loudness (LUFS)
          </h2>
          <div className="grid md:grid-cols-5 gap-3 mb-4">
            {lufsStandards.map(standard => (
              <button
                key={standard.name}
                onClick={() => setMasteringSettings({ ...masteringSettings, targetLUFS: standard.value })}
                className={`p-3 rounded-lg transition-all ${
                  masteringSettings.targetLUFS === standard.value
                    ? 'bg-gradient-to-r from-purple-600 to-pink-600 shadow-lg'
                    : 'bg-gray-700 hover:bg-gray-600'
                }`}
              >
                <div className="font-semibold">{standard.name}</div>
                <div className="text-sm text-gray-300">{standard.value} LUFS</div>
                <div className="text-xs text-gray-400">{standard.desc}</div>
              </button>
            ))}
          </div>
          <div className="flex items-center gap-4">
            <label className="text-sm text-gray-400 w-32">Custom Target:</label>
            <input
              type="range"
              min="-30"
              max="-5"
              value={masteringSettings.targetLUFS}
              onChange={(e) => setMasteringSettings({ ...masteringSettings, targetLUFS: parseInt(e.target.value) })}
              className="flex-1"
            />
            <span className="text-lg font-semibold w-20 text-right">{masteringSettings.targetLUFS} LUFS</span>
          </div>
        </div>

        {/* Advanced Controls */}
        <div className="bg-gray-800 rounded-lg p-6 mb-6 border border-purple-500/30">
          <h2 className="text-xl font-semibold mb-4">Advanced Controls</h2>
          <div className="space-y-4">
            {[
              { key: 'compression', label: 'Compression', desc: 'Dynamic range control' },
              { key: 'eq', label: 'EQ Enhancement', desc: 'Frequency balance' },
              { key: 'stereoWidth', label: 'Stereo Width', desc: 'Spatial imaging' },
              { key: 'saturation', label: 'Harmonic Saturation', desc: 'Warmth & character' }
            ].map(control => (
              <div key={control.key}>
                <div className="flex justify-between mb-2">
                  <div>
                    <span className="font-medium">{control.label}</span>
                    <span className="text-sm text-gray-400 ml-2">{control.desc}</span>
                  </div>
                  <span className="text-purple-400">{masteringSettings[control.key]}%</span>
                </div>
                <input
                  type="range"
                  min="0"
                  max="100"
                  value={masteringSettings[control.key]}
                  onChange={(e) => setMasteringSettings({ ...masteringSettings, [control.key]: parseInt(e.target.value) })}
                  className="w-full"
                />
              </div>
            ))}
          </div>
        </div>

        {/* Export Button */}
        <div className="flex justify-center">
          <button
            onClick={handleExport}
            disabled={!audioFile}
            className={`flex items-center gap-2 px-8 py-4 rounded-lg font-semibold text-lg transition-all ${
              audioFile
                ? 'bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 shadow-lg hover:shadow-xl'
                : 'bg-gray-700 cursor-not-allowed opacity-50'
            }`}
          >
            <Download className="w-6 h-6" />
            Export Mastered Audio
          </button>
        </div>

        {referenceFile && (
          <div className="mt-6 bg-gray-800 rounded-lg p-4 border border-pink-500/30">
            <p className="text-center text-sm text-gray-400">
              Reference track loaded: <span className="text-pink-400">{referenceFile.name}</span>
              <br />
              <span className="text-xs">Analysis would compare spectral content, loudness, and dynamics</span>
            </p>
          </div>
        )}
      </div>
    </div>
  );
};

export default AudioMasteringTool;
